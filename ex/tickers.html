<!DOCTYPE html><html><head><title>Haskell by Example: Tickers</title><link rel="stylesheet" href="../css/main.css"><link rel="stylesheet" href="../css/prism.css"><script src="../js/prism.js"></script></head><body><div class="example"><h1>Haskell by Example: Tickers</h1><a href="https://gobyexample.com/tickers">original</a><p>To work this example, you need install <a href="https://hackage.haskell.org/package/io-streams">io-stream</a>.</p>
<pre><code class="language-bash">$ cabal install io-stream</code></pre>
<pre><code class="language-haskell">import Control.Concurrent
import Control.Monad.IO.Class
import Data.Time
import Data.IORef
import System.IO.Streams (InputStream, makeOutputStream, fromGenerator, connect)
import qualified System.IO.Streams as Streams

main = do
    ticker &lt;- newTicker (500 * 1000)
    output &lt;- makeOutputStream $ \m -&gt; case m of
                  Just now -&gt; print now
                  Nothing  -&gt; return ()
    forkIO $ (snd ticker) `connect` output

    threadDelay (1500 * 1000)
    stopTicker ticker
    putStrLn &quot;Ticker stopped&quot;

data State  = Start | Stop
type Ticker = (IORef State, InputStream UTCTime)

newTicker :: Int -&gt; IO Ticker
newTicker delay = do
    state  &lt;- newIORef Start
    stream &lt;- fromGenerator (gen state)
    return (state, stream)
    where
    gen state = do
        runState &lt;- liftIO $ readIORef state
        case runState of
            Start -&gt; do
                now &lt;- liftIO getCurrentTime
                Streams.yield now
                liftIO $ threadDelay delay
                gen state
            Stop -&gt; return ()

stopTicker :: Ticker -&gt; IO ()
stopTicker (state, _) = writeIORef state Stop</code></pre>
<pre><code class="language-bash">$ runhaskell tickers.hs
2015-05-05 12:30:57.82369 UTC
2015-05-05 12:30:58.330511 UTC
2015-05-05 12:30:58.834687 UTC
Ticker stopped</code></pre><a href="../">back to index</a></div></body></html>