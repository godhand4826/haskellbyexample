<!DOCTYPE html><html><head><title>Haskell by Example: Mutexes</title><link rel="stylesheet" href="../css/main.css"><link rel="stylesheet" href="../css/prism.css"><script src="../js/prism.js"></script></head><body><div class="example"><h1>Haskell by Example: Mutexes</h1><a href="https://gobyexample.com/mutexes">original</a><pre><code class="language-haskell">import Control.Monad
import Control.Concurrent
import Control.Concurrent.STM
import Data.Maybe
import qualified Data.Map as Map
import System.Random

main = do
    state &lt;- atomically $ newTVar Map.empty
    ops   &lt;- atomically $ newTVar 0

    forM_ [0..99] $ \_ -&gt; do
        total &lt;- atomically $ newTVar 0
        forkIO . forever $ do
            key &lt;- randomRIO (0, 4) :: IO Int
            atomically $ do
                s &lt;- readTVar state
                writeTVar state s
                let v = maybe 0 id $ Map.lookup key s
                modifyTVar total (+v)
                modifyTVar ops (+1)

    forM_ [0..9] $ \_ -&gt; do
        forkIO . forever $ do
            key &lt;- randomRIO (0, 4) :: IO Int
            val &lt;- randomRIO (0, 99) :: IO Int
            atomically $ do
                modifyTVar state (Map.insert key val)
                modifyTVar ops (+1)

    threadDelay 1000000
    opsFinal &lt;- atomically $ readTVar ops
    putStrLn $ &quot;ops: &quot; ++ show opsFinal

    s &lt;- atomically $ readTVar state
    putStrLn $ &quot;state: &quot; ++ show s</code></pre>
<pre><code class="language-bash">$ runhaskell mutexes.hs
ops: 299042
state: fromList [(0,50),(1,81),(2,55),(3,87),(4,47)]</code></pre><a href="../">back to index</a></div></body></html>