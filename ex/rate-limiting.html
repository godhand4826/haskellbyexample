<!DOCTYPE html><html><head><title>Haskell by Example: Rate Limiting</title><link rel="stylesheet" href="../css/main.css"><link rel="stylesheet" href="../css/prism.css"><script src="../js/prism.js"></script></head><body><div class="example"><h1>Haskell by Example: Rate Limiting</h1><a href="https://gobyexample.com/rate-limiting">original</a><pre><code class="language-haskell">import Data.Time
import Control.Monad
import Control.Concurrent
import Control.Concurrent.STM

main = do
    requests &lt;- atomically $ do
        req &lt;- newTQueue
        mapM_ (writeTQueue req) [1..5]
        return req

    limitter &lt;- atomically $ newEmptyTMVar
    forkIO . forever $ do
        atomically $ putTMVar limitter ()
        threadDelay (200 * 1000)

    let loop1 = do
        req &lt;- atomically $ do
            r &lt;- readTQueue requests
            takeTMVar limitter
            return r
        now &lt;- getCurrentTime
        putStrLn $ &quot;request &quot; ++ show req ++ &quot; &quot; ++ show now
        isEmpty &lt;- atomically $ isEmptyTQueue requests
        if isEmpty
            then return ()
            else loop1
    loop1

    now &lt;- getCurrentTime
    burstyLimitter &lt;- atomically $ do
        limitter &lt;- newTBQueue 3
        forM_ [0..2] $ \_ -&gt; writeTBQueue limitter now
        return limitter

    forkIO . forever $ do
        now &lt;- getCurrentTime
        atomically $ writeTBQueue burstyLimitter now
        threadDelay (200 * 1000)

    burstyRequests &lt;- atomically $ do
        req &lt;- newTQueue
        mapM_ (writeTQueue req) [1..5]
        return req

    let loop2 = do
        req &lt;- atomically $ do
            r &lt;- readTQueue burstyRequests
            readTBQueue burstyLimitter
            return r
        now &lt;- getCurrentTime
        putStrLn $ &quot;request &quot; ++ show req ++ &quot; &quot; ++ show now
        isEmpty &lt;- atomically $ isEmptyTQueue burstyRequests
        if isEmpty
            then return ()
            else loop2
    loop2</code></pre>
<pre><code class="language-bash">$ runhaskell rate-limiting.hs
request 1 2018-10-18 21:22:30.873766 UTC
request 2 2018-10-18 21:22:31.074185 UTC
request 3 2018-10-18 21:22:31.274635 UTC
request 4 2018-10-18 21:22:31.474943 UTC
request 5 2018-10-18 21:22:31.675533 UTC
request 1 2018-10-18 21:22:31.675713 UTC
request 2 2018-10-18 21:22:31.675839 UTC
request 3 2018-10-18 21:22:31.675947 UTC
request 4 2018-10-18 21:22:31.676057 UTC
request 5 2018-10-18 21:22:31.876147 UTC</code></pre><a href="../">back to index</a></div></body></html>